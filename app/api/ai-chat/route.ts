// app/api/ai-chat/route.ts
import { NextRequest, NextResponse } from 'next/server';
import jwt from 'jsonwebtoken';
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;
const supabase = createClient(supabaseUrl, supabaseServiceKey);

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';

interface JwtPayload {
  userId: string;
  username: string;
  iat?: number;
  exp?: number;
}

// ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
interface EmotionAnalysis {
  primary: string;
  intensity: number;
  tone: string;
}

interface ContextAnalysis {
  problemType: string;
  severity: string;
  needs: string[];
}

function analyzeEmotion(message: string): EmotionAnalysis {
  const lowerMessage = message.toLowerCase();
  
  // ‡∏Ñ‡∏≥‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå
  const emotions = {
    sad: ['‡πÄ‡∏®‡∏£‡πâ‡∏≤', '‡∏´‡∏î‡∏´‡∏π‡πà', '‡∏ú‡∏¥‡∏î‡∏´‡∏ß‡∏±‡∏á', '‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à', '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤', '‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ', '‡πÄ‡∏´‡∏á‡∏≤'],
    angry: ['‡πÇ‡∏Å‡∏£‡∏ò', '‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î', '‡∏£‡∏≥‡∏Ñ‡∏≤‡∏ç', '‡∏Ç‡∏±‡∏î‡πÉ‡∏à', '‡∏´‡∏±‡∏ß‡πÄ‡∏™‡∏µ‡∏¢'],
    worried: ['‡∏Å‡∏±‡∏á‡∏ß‡∏•', '‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î', '‡∏Å‡∏•‡∏±‡∏ß', '‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à', '‡∏´‡πà‡∏ß‡∏á'],
    happy: ['‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç', '‡∏î‡∏µ‡πÉ‡∏à', '‡∏™‡∏ô‡∏∏‡∏Å', '‡∏£‡∏±‡∏Å', '‡∏´‡∏ß‡∏≤‡∏ô'],
    confused: ['‡∏á‡∏á', '‡∏™‡∏±‡∏ö‡∏™‡∏ô', '‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à', '‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ']
  };

  let primaryEmotion = 'neutral';
  let maxMatches = 0;
  
  for (const [emotion, keywords] of Object.entries(emotions)) {
    const matches = keywords.filter(keyword => lowerMessage.includes(keyword)).length;
    if (matches > maxMatches) {
      maxMatches = matches;
      primaryEmotion = emotion;
    }
  }

  const intensity = Math.min(maxMatches * 3 + 2, 10);
  
  let tone = 'normal';
  if (lowerMessage.includes('!')) tone = 'urgent';
  else if (lowerMessage.includes('?')) tone = 'questioning';

  return { primary: primaryEmotion, intensity, tone };
}

function analyzeContext(message: string): ContextAnalysis {
  const lowerMessage = message.toLowerCase();
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©
  if (lowerMessage.includes('‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô') || lowerMessage.includes('‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô') || lowerMessage.includes('‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤')) {
    return { problemType: 'story', severity: 'normal', needs: ['entertainment'] };
  } else if (lowerMessage.includes('‡∏ï‡∏•‡∏Å') || lowerMessage.includes('‡∏°‡∏∏‡∏Å') || lowerMessage.includes('‡∏Æ‡∏≤') || lowerMessage.includes('‡∏Ç‡∏≥')) {
    return { problemType: 'joke', severity: 'normal', needs: ['entertainment'] };
  } else if (lowerMessage.includes('‡πÅ‡∏õ‡∏•') || lowerMessage.includes('translate') || lowerMessage.includes('‡∏†‡∏≤‡∏©‡∏≤')) {
    return { problemType: 'translate', severity: 'normal', needs: ['translation'] };
  } else if (lowerMessage.includes('‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì') || lowerMessage.includes('‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç') || lowerMessage.includes('‡∏ö‡∏ß‡∏Å') || 
             lowerMessage.includes('‡∏•‡∏ö') || lowerMessage.includes('‡∏Ñ‡∏π‡∏ì') || lowerMessage.includes('‡∏´‡∏≤‡∏£') ||
             /\d+\s*[\+\-\*\/]\s*\d+/.test(lowerMessage)) {
    return { problemType: 'math', severity: 'normal', needs: ['calculation'] };
  } else if (lowerMessage.includes('‡πÄ‡∏Å‡∏°') || lowerMessage.includes('‡πÄ‡∏•‡πà‡∏ô') || lowerMessage.includes('‡∏™‡∏ô‡∏∏‡∏Å')) {
    return { problemType: 'game', severity: 'normal', needs: ['entertainment'] };
  } else if (lowerMessage.includes('‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£') || lowerMessage.includes('‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£') || lowerMessage.includes('‡πÄ‡∏°‡∏ô‡∏π')) {
    return { problemType: 'recipe', severity: 'normal', needs: ['advice'] };
  } else if (lowerMessage.includes('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥') && (lowerMessage.includes('‡πÄ‡∏î‡∏ó') || lowerMessage.includes('‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß') || lowerMessage.includes('‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß'))) {
    return { problemType: 'date_idea', severity: 'normal', needs: ['advice'] };
  }
  
  let problemType = 'general';
  if (lowerMessage.includes('‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞') || lowerMessage.includes('‡πÇ‡∏ï‡πâ‡πÄ‡∏ñ‡∏µ‡∏¢‡∏á')) {
    problemType = 'conflict';
  } else if (lowerMessage.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à') || lowerMessage.includes('‡∏Ñ‡∏∏‡∏¢')) {
    problemType = 'communication';
  } else if (lowerMessage.includes('‡πÑ‡∏°‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏à') || lowerMessage.includes('‡πÇ‡∏Å‡∏´‡∏Å')) {
    problemType = 'trust';
  } else if (lowerMessage.includes('‡∏´‡∏∂‡∏á') || lowerMessage.includes('‡∏≠‡∏¥‡∏à‡∏â‡∏≤')) {
    problemType = 'jealousy';
  }

  const severity = lowerMessage.includes('‡∏ó‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß') || lowerMessage.includes('‡πÄ‡∏•‡∏¥‡∏Å') ? 'high' : 'normal';
  
  const needs = [];
  if (lowerMessage.includes('‡∏ä‡πà‡∏ß‡∏¢') || lowerMessage.includes('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥')) needs.push('advice');
  if (lowerMessage.includes('‡∏ü‡∏±‡∏á') || lowerMessage.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à')) needs.push('support');

  return { problemType, severity, needs: needs.length > 0 ? needs : ['support'] };
}

export async function POST(request: NextRequest) {
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token
    const authHeader = request.headers.get('authorization');
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const token = authHeader.substring(7);
    let userId: string;

    try {
      const decoded = jwt.verify(token, JWT_SECRET) as JwtPayload;
      userId = decoded.userId;
    } catch {
      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÉ‡∏ä‡πâ
    const { data: userData, error: userError } = await supabase
      .from('custom_users')
      .select('username')
      .eq('id', userId)
      .single();

    if (userError || !userData) {
      return NextResponse.json({ error: 'User not found' }, { status: 404 });
    }

    const { message } = await request.json();

    if (!message || typeof message !== 'string') {
      return NextResponse.json({ error: 'Message is required' }, { status: 400 });
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    const { error: userMessageError } = await supabase
      .from('ai_chat_messages')
      .insert({
        user_id: userId,
        role: 'user',
        content: message.trim()
      });

    if (userMessageError) {
      console.error('Error saving user message:', userMessageError);
    }

    const openAiApiKey = process.env.OPENAI_API_KEY;
    const emotionAnalysis = analyzeEmotion(message);
    const context = analyzeContext(message);
    
    let aiResponse: string;
    let responseSource: string;
    
    if (!openAiApiKey) {
      aiResponse = getFallbackResponse(message, emotionAnalysis, context, userData.username);
      responseSource = 'fallback';
    } else {
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${openAiApiKey}`,
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó AI ‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÄ‡∏Å‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏°‡∏≤‡∏Å‡πÜ üíï

üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
1. ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å
2. ‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏±‡πâ‡∏ô ‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å
3. ‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∏‡∏Å‡∏ï‡∏•‡∏Å ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≥‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢
4. ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ (‡πÑ‡∏ó‡∏¢-‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
5. ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡πÅ‡∏Å‡πâ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
6. ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏ó ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß
7. ‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£
8. ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤ ‡∏ó‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤

üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:
- ‡∏ä‡∏∑‡πà‡∏≠: ${userData.username}
- ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: ${emotionAnalysis.primary} (${emotionAnalysis.intensity}/10)
- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${context.problemType}
- ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ${context.needs.join(', ')}

‚ö° ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "‡∏Ñ‡∏∏‡∏ì${userData.username}" ‡πÄ‡∏™‡∏°‡∏≠
- ‡∏û‡∏π‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£
- ‡πÉ‡∏™‡πà‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
- ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 40-80 ‡∏Ñ‡∏≥ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£)
- ‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
- ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à

üé™ ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠:
- ‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô: ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ 3-4 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏°‡∏µ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô
- ‡∏°‡∏∏‡∏Å‡∏ï‡∏•‡∏Å: ‡∏ï‡∏•‡∏Å‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å
- ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤: ‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
- ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç: ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
- ‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏ó: ‡πÄ‡∏™‡∏ô‡∏≠ 2-3 ‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
- ‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£: ‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "‡∏Ñ‡∏∏‡∏ì${userData.username} ‡∏≠‡∏¢‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡πÄ‡∏´‡∏£‡∏≠? ÔøΩ ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏µ‡πÜ ‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á..."

‡∏à‡∏≥‡πÑ‡∏ß‡πâ: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏°‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏£‡∏π ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πà‡∏á‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á!`
              },
              {
                role: 'user',
                content: message
              }
            ],
            temperature: 0.8,
            max_tokens: 120,
            top_p: 0.95,
            frequency_penalty: 0.2,
            presence_penalty: 0.3
          }),
        });

        if (!response.ok) {
          aiResponse = getFallbackResponse(message, emotionAnalysis, context, userData.username);
          responseSource = 'fallback';
        } else {
          const data = await response.json();
          aiResponse = data.choices?.[0]?.message?.content || getFallbackResponse(message, emotionAnalysis, context, userData.username);
          responseSource = 'openai';
        }
      } catch {
        aiResponse = getFallbackResponse(message, emotionAnalysis, context, userData.username);
        responseSource = 'fallback';
      }
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á AI
    const { error: aiMessageError } = await supabase
      .from('ai_chat_messages')
      .insert({
        user_id: userId,
        role: 'model',
        content: aiResponse
      });

    if (aiMessageError) {
      console.error('Error saving AI message:', aiMessageError);
    }

    return NextResponse.json({ 
      response: aiResponse,
      source: responseSource,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('AI Chat API error:', error);
    // ‡πÉ‡∏ä‡πâ fallback response ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    const fallbackResponse = "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡∏î‡∏π ‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏Å‡∏±‡∏ô üíï";
    return NextResponse.json({ 
      response: fallbackResponse,
      source: 'fallback'
    }, { status: 200 });
  }
}

export async function GET(request: NextRequest) {
  try {
    const authHeader = request.headers.get('authorization');
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const token = authHeader.substring(7);
    let userId: string;

    try {
      const decoded = jwt.verify(token, JWT_SECRET) as JwtPayload;
      userId = decoded.userId;
    } catch {
      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
    }

    // Get pagination parameters
    const { searchParams } = new URL(request.url);
    const page = parseInt(searchParams.get('page') || '1');
    const limit = parseInt(searchParams.get('limit') || '50');
    const offset = (page - 1) * limit;

    // Get total count
    const { count } = await supabase
      .from('ai_chat_messages')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', userId);

    // Get paginated messages
    const { data: messages, error } = await supabase
      .from('ai_chat_messages')
      .select('id, role, content, created_at')
      .eq('user_id', userId)
      .order('created_at', { ascending: true })
      .range(offset, offset + limit - 1);

    if (error) {
      return NextResponse.json({ error: 'Failed to fetch chat history' }, { status: 500 });
    }

    return NextResponse.json({ 
      messages: messages || [],
      pagination: {
        page,
        limit,
        total: count || 0,
        totalPages: Math.ceil((count || 0) / limit),
        hasNext: page * limit < (count || 0),
        hasPrev: page > 1
      }
    });

  } catch {
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}

// ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà - ‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠
function getFallbackResponse(message: string, emotion: EmotionAnalysis, context: ContextAnalysis, username: string): string {
  const lowerMessage = message.toLowerCase();
  
  // ‡∏Ñ‡∏≥‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
  if (lowerMessage.includes('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ') || lowerMessage.includes('hi') || lowerMessage.includes('hello')) {
    const greetings = [
      `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞‡∏Ñ‡∏∏‡∏ì${username}! ‡∏â‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∏‡∏Å ‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ô‡∏∞ üíï`,
      `‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ‡∏Ñ‡πà‡∏∞‡∏Ñ‡∏∏‡∏ì${username}! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏ö‡πâ‡∏≤‡∏á? ‡∏â‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÑ‡∏õ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ üòä`,
      `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì${username}! ‡∏â‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏°‡∏±‡πâ‡∏¢? ‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∏‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ üå∏`
    ];
    return greetings[Math.floor(Math.random() * greetings.length)];
  }

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
  if (lowerMessage.includes('‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£') || lowerMessage.includes('‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä') || lowerMessage.includes('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß')) {
    return `‡∏â‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä‡∏Ñ‡πà‡∏∞‡∏Ñ‡∏∏‡∏ì${username}! ‡πÄ‡∏õ‡πá‡∏ô AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ü•∞ ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô ‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∏‡∏Å ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏ó ‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏Å‡πá‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏ô‡∏∞`;
  }

  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏´‡∏°‡πà
  if (context.problemType === 'story') {
    const stories = [
      `‡∏Ñ‡∏∏‡∏ì${username} ‡∏°‡∏µ‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á üìö "‡∏Å‡∏≤‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏û‡∏ß‡∏Å‡πÄ‡∏Ç‡∏≤‡∏Å‡πá‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ ‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å ‡πÅ‡∏•‡∏∞‡∏û‡∏ß‡∏Å‡πÄ‡∏Ç‡∏≤‡∏Å‡πá‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ" ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞? üíï`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏≠‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏ù‡∏≤‡∏Å üåô "‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏Å‡∏±‡∏ö‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß ‡∏£‡∏±‡∏Å‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏û‡∏ß‡∏Å‡πÄ‡∏Ç‡∏≤‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏û‡∏ß‡∏Å‡πÄ‡∏Ç‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠" ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏Å‡∏•‡∏Å‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚ú®`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á ü¶ã "‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ö‡∏¥‡∏ô‡∏´‡∏≤‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏´‡∏≤‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô‡∏°‡∏≤‡∏Å ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏à‡∏≠‡∏ß‡πà‡∏≤ ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏î‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î" ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∞ üå∫`
    ];
    return stories[Math.floor(Math.random() * stories.length)];
  }

  if (context.problemType === 'joke') {
    const jokes = [
      `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏≠‡∏≤‡∏°‡∏∏‡∏Å‡∏°‡∏≤‡∏ù‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß! üòÑ "‡∏ó‡∏≥‡πÑ‡∏°‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏ñ‡∏∂‡∏á‡∏ä‡∏≠‡∏ö‡∏Å‡∏¥‡∏ô‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°? ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡πà‡∏≤...‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô!" ‡∏≠‡∏¥‡∏≠‡∏¥ ‡∏Ç‡∏≥‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞?`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡∏°‡∏µ‡∏°‡∏∏‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å ü§≠ "‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ôWi-Fi ‡∏ó‡∏≥‡πÑ‡∏°? ‡πÄ‡∏û‡∏£‡∏≤‡∏∞...‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πá‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ!" ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏à‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏î‡πâ‡∏ß‡∏¢ üíï`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∏‡∏Å‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á üòÇ "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤ ‡∏ó‡∏≥‡πÑ‡∏°? ‡πÄ‡∏û‡∏£‡∏≤‡∏∞...‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏π‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ï‡∏•‡∏≠‡∏î!" ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏ö‡πÄ‡∏•‡∏¢‡πÉ‡∏ä‡πà‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡∏°‡∏∏‡∏Å‡∏≠‡∏µ‡∏Å‡πÅ‡∏•‡πâ‡∏ß! üôà "‡∏ó‡∏≥‡πÑ‡∏°‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å‡∏ñ‡∏∂‡∏á‡∏ä‡∏≠‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á? ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡πà‡∏≤...‡πÑ‡∏î‡πâ‡∏ô‡∏±‡πà‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏∑‡∏î‡πÜ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏¢!" ‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å‡∏î‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞`
    ];
    return jokes[Math.floor(Math.random() * jokes.length)];
  }

  if (context.problemType === 'translate') {
    return `‡∏Ñ‡∏∏‡∏ì${username} ‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏õ‡∏•‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞? ‡∏ö‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏•‡∏¢! üåê ‡∏â‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ó‡∏¢-‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏î‡πâ‡∏ß‡∏¢ ‡πÅ‡∏Ñ‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡πÅ‡∏õ‡∏• [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°] ‡πÄ‡∏õ‡πá‡∏ô [‡∏†‡∏≤‡∏©‡∏≤]" ‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢ ‚ú®`;
  }

  if (context.problemType === 'math') {
    // ‡∏•‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏á‡πà‡∏≤‡∏¢‡πÜ
    const mathMatch = lowerMessage.match(/(\d+(?:\.\d+)?)\s*([\+\-\*\/])\s*(\d+(?:\.\d+)?)/);
    if (mathMatch) {
      const [, num1, operator, num2] = mathMatch;
      const n1 = parseFloat(num1);
      const n2 = parseFloat(num2);
      let result;
      let opText;
      
      switch (operator) {
        case '+': result = n1 + n2; opText = '‡∏ö‡∏ß‡∏Å'; break;
        case '-': result = n1 - n2; opText = '‡∏•‡∏ö'; break;
        case '*': result = n1 * n2; opText = '‡∏Ñ‡∏π‡∏ì'; break;
        case '/': result = n2 !== 0 ? n1 / n2 : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÑ‡∏î‡πâ'; opText = '‡∏´‡∏≤‡∏£'; break;
        default: result = '‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à'; opText = '';
      }
      
      if (typeof result === 'number') {
        return `‡∏Ñ‡∏∏‡∏ì${username} ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß! üßÆ ${num1} ${opText} ${num2} = ${result} ‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏Å‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢! ‚ú®`;
      }
    }
    return `‡∏Ñ‡∏∏‡∏ì${username} ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞? ü§ì ‡∏ö‡∏≠‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏°‡∏≤‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ö‡∏ß‡∏Å ‡∏•‡∏ö ‡∏Ñ‡∏π‡∏ì ‡∏´‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏¢‡∏≤‡∏Å‡πÜ ‡∏â‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏ô‡∏∞!`;
  }

  if (context.problemType === 'date_idea') {
    const dateIdeas = [
      `‡∏Ñ‡∏∏‡∏ì${username} ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏ó‡πÄ‡∏´‡∏£‡∏≠? üí° ‡∏•‡∏≠‡∏á‡πÑ‡∏õ "‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô + ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤ + ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°" ‡∏™‡∏ö‡∏≤‡∏¢‡πÜ ‡πÅ‡∏ï‡πà‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏≤‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏õ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î + ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏ó‡∏≤‡∏á + ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô" ‡∏Å‡πá‡∏î‡∏µ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏∞`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏≠‡∏≤‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏ó‡∏°‡∏≤‡∏ù‡∏≤‡∏Å! üåü "‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô + ‡∏î‡∏π‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏õ‡∏¥‡∏Å‡∏ô‡∏¥‡∏Å‡πÉ‡∏ô‡∏™‡∏ß‡∏ô + ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡∏±‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏õ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ + ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Å‡πá‡∏´‡∏ß‡∏≤‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏ó‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß üíï "‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô‡πÜ + ‡∏Å‡∏¥‡∏ô‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏õ‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á + ‡∏î‡∏π‡∏Ç‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡∏¢‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô + ‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á + ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô" ‡∏Å‡πá‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å‡∏î‡∏µ‡∏ô‡∏∞`
    ];
    return dateIdeas[Math.floor(Math.random() * dateIdeas.length)];
  }

  if (context.problemType === 'recipe') {
    const recipes = [
      `‡∏Ñ‡∏∏‡∏ì${username} ‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏´‡∏£‡∏≠? üë©‚Äçüç≥ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ "‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß‡∏á‡πà‡∏≤‡∏¢‡πÜ" ‡πÄ‡∏≠‡∏≤‡πÑ‡∏Ç‡πà 2 ‡∏ü‡∏≠‡∏á + ‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤ + ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô ‡∏ï‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≠‡∏î‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡πâ‡∏≠‡∏ô‡πÜ ‡∏Å‡∏¥‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏ß‡∏¢‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å! ‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏î‡∏π‡∏°‡∏±‡πâ‡∏¢? üòä`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏°‡∏ô‡∏π‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üçù "‡∏™‡∏õ‡∏≤‡πÄ‡∏Å‡πá‡∏ï‡∏ï‡∏µ‡πâ‡πÄ‡∏ö‡∏™‡∏¥‡∏Ñ" ‡∏ï‡πâ‡∏°‡πÄ‡∏™‡πâ‡∏ô + ‡∏ú‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏ã‡∏≠‡∏™‡∏û‡∏≤‡∏™‡∏ï‡πâ‡∏≤ + ‡πÉ‡∏™‡πà‡∏´‡∏°‡∏π‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏Å‡πà + ‡∏ä‡∏µ‡∏™ ‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å‡∏î‡∏µ‡πÄ‡∏•‡∏¢`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏ß‡∏≤‡∏ô‡πÜ ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏ù‡∏≤‡∏Å üßÅ "‡∏õ‡∏≤‡∏î‡∏´‡∏°‡πâ‡∏≠‡∏á‡πà‡∏≤‡∏¢‡πÜ" ‡∏ô‡∏°‡∏™‡∏î + ‡πÑ‡∏Ç‡πà + ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• + ‡πÅ‡∏õ‡πâ‡∏á ‡∏ô‡∏ß‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∂‡πà‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏Å‡∏¥‡∏ô‡∏Å‡∏±‡∏ô ‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÄ‡∏•‡∏¢!`
    ];
    return recipes[Math.floor(Math.random() * recipes.length)];
  }

  if (context.problemType === 'game') {
    const games = [
      `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Å‡∏±‡∏ô‡∏°‡∏±‡πâ‡∏¢? üéÆ ‡∏â‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤: "‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡πâ ‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞?" ‡∏Ñ‡∏¥‡∏î‡∏î‡∏π ‡∏ï‡∏≠‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡∏¢! (‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ: ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å üíï)`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞! üß© "‡∏°‡∏µ 4 ‡∏Ç‡∏≤ ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ ‡∏°‡∏µ 2 ‡∏Ç‡∏≤ ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢ ‡∏°‡∏µ 3 ‡∏Ç‡∏≤ ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?" ‡∏Ñ‡∏¥‡∏î‡∏î‡∏π‡∏ô‡∏∞!`,
      `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏Å‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üéØ ‡∏â‡∏±‡∏ô‡∏Ñ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1-10 ‡∏•‡∏≠‡∏á‡∏ó‡∏≤‡∏¢‡∏î‡∏π! ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡∏ó‡∏≤‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ñ‡∏∏‡∏ì‡∏î‡∏µ‡∏°‡∏±‡πâ‡∏¢? ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô!`
    ];
    return games[Math.floor(Math.random() * games.length)];
  }

  // ‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å (‡πÄ‡∏Å‡πà‡∏≤)
  const responses = {
    sad: {
      conflict: `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏à‡πá‡∏ö‡πÉ‡∏à‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢ üò¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏•‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡πÜ ‡∏î‡∏µ‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞? ‡∏Ç‡∏≠‡∏Å‡∏≠‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞ ü§ó`,
      communication: `‡∏Ñ‡∏∏‡∏ì${username} ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏®‡∏£‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏±‡∏ô üíô ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ï‡∏£‡∏á‡πÜ ‡πÅ‡∏ï‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡πá‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô`,
      trust: `‡∏Ñ‡∏∏‡∏ì${username} ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πá‡∏ö‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÜ üíî ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡∏Å‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏£‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Å‡∏±‡∏ô ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`,
      general: `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏®‡∏£‡πâ‡∏≤‡∏ô‡∏∞ üòî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏°‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÜ ‡∏•‡∏á‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏Ñ‡πà‡∏∞ üå∑`
    },
    angry: {
      conflict: `‡∏Ñ‡∏∏‡∏ì${username} ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÇ‡∏Å‡∏£‡∏ò‡∏°‡∏≤‡∏Å‡πÜ ‡πÄ‡∏•‡∏¢ üò§ ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏∞ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏∂‡∏Å‡πÜ ‡∏û‡∏≠‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô ‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏´‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞`,
      communication: `‡∏Ñ‡∏∏‡∏ì${username} ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Å‡∏£‡∏ò‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏±‡∏ô üß° ‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ö‡∏≤‡πÜ ‡∏ü‡∏±‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏∞`,
      general: `‡∏Ñ‡∏∏‡∏ì${username} ‡πÇ‡∏Å‡∏£‡∏ò‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å üåä ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏∞`
    },
    worried: {
      trust: `‡∏Ñ‡∏∏‡∏ì${username} ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞ üå± ‡∏•‡∏≠‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏£‡∏á‡πÜ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏à‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏ó‡∏≥‡∏Å‡∏±‡∏ô‡∏ô‡∏∞`,
      general: `‡∏Ñ‡∏∏‡∏ì${username} ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏°‡∏≤‡∏Å üíõ ‡∏•‡∏≠‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏π‡∏Ñ‡πà‡∏∞`
    },
    happy: {
      general: `‡∏Ñ‡∏∏‡∏ì${username} ‡∏î‡∏µ‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç! üåü ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏µ‡πÜ ‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏ô‡∏≤‡∏ô‡πÜ ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏î‡∏µ‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞`
    },
    confused: {
      communication: `‡∏Ñ‡∏∏‡∏ì${username} ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏™‡∏±‡∏ö‡∏™‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡πà‡∏∞ üîÆ ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏£‡∏á‡πÜ ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ô‡∏∞`,
      general: `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ö‡∏™‡∏ô ‡∏•‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‚≠ê ‡∏ñ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡∏Ñ‡πà‡∏∞`
    }
  };

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏ç‡∏´‡∏≤
  const emotionResponses = responses[emotion.primary as keyof typeof responses];
  if (emotionResponses) {
    const contextResponse = emotionResponses[context.problemType as keyof typeof emotionResponses] || 
                           emotionResponses.general || 
                           emotionResponses[Object.keys(emotionResponses)[0] as keyof typeof emotionResponses];
    if (contextResponse) return contextResponse;
  }

  // ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠
  const generalResponses = [
    `‡∏Ñ‡∏∏‡∏ì${username} ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ñ‡πà‡∏∞ üíï ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡∏â‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∏‡∏Å ‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ô‡∏∞ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏•‡∏¢!`,
    `‡∏Ñ‡∏∏‡∏ì${username} ‡∏â‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ü‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡πà‡∏∞ üå∏ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏•‡πà‡∏≤‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏≤`,
    `‡∏Ñ‡∏∏‡∏ì${username} ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞? ‚ú® ‡∏â‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÑ‡∏õ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏ô‡∏∏‡∏Å‡πÜ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏ô‡∏∞`,
    `‡∏Ñ‡∏∏‡∏ì${username} ‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏∞ üòä ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ ‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≥‡πÜ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏°‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏•‡πà‡∏≤‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!`,
    `‡∏Ñ‡∏∏‡∏ì${username} ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞? üí´ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏à ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏ô‡∏∏‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏â‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏™‡∏°‡∏≠‡∏ô‡∏∞`
  ];
  
  return generalResponses[Math.floor(Math.random() * generalResponses.length)];
}
